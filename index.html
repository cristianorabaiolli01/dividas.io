<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>MinhasEconomias | Controle Financeiro Pessoal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
  min-height: 100vh;
}

.glass {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.shadow-soft {
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.05);
}

.shadow-glow {
  box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
}

.fade-in {
  animation: fadeIn 0.5s ease-out;
}

.slide-up {
  animation: slideUp 0.4s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.pulse {
  animation: pulse 2s infinite;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

/* Loading skeleton */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
</style>
</head>

<body class="min-h-screen text-slate-800 font-sans">

<!-- LOGIN SCREEN -->
<div id="loginTela" class="min-h-screen flex items-center justify-center px-4">
  <div class="glass w-full max-w-md p-8 md:p-10 rounded-3xl shadow-soft shadow-glow slide-up">
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-emerald-400 to-green-500 rounded-2xl mb-4 shadow-md">
        <i class="fas fa-wallet text-white text-2xl"></i>
      </div>
      <h1 class="text-3xl font-bold bg-gradient-to-r from-emerald-600 to-green-600 bg-clip-text text-transparent">
        MinhasEconomias
      </h1>
      <p class="text-slate-500 mt-2">Controle financeiro inteligente e simples</p>
    </div>

    <div class="space-y-5">
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
        <div class="relative">
          <i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
          <input id="email" type="email" placeholder="seu@email.com"
            class="w-full pl-12 pr-4 py-3.5 rounded-xl border border-slate-200 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition-all duration-200">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Senha</label>
        <div class="relative">
          <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
          <input id="senha" type="password" placeholder="Sua senha"
            class="w-full pl-12 pr-12 py-3.5 rounded-xl border border-slate-200 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition-all duration-200">
          <button type="button" id="togglePassword" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <button id="btnLogin"
        class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white font-semibold py-3.5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
        <i class="fas fa-sign-in-alt"></i>
        Entrar na conta
      </button>

      <div class="relative my-6">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-slate-200"></div>
        </div>
        <div class="relative flex justify-center text-sm">
          <span class="px-4 bg-white text-slate-500">ou crie uma conta</span>
        </div>
      </div>

      <button id="btnRegistrar"
        class="w-full border border-slate-300 hover:border-emerald-400 text-slate-700 hover:text-emerald-700 font-medium py-3.5 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
        <i class="fas fa-user-plus"></i>
        Criar conta gratuita
      </button>
    </div>

    <p id="msg" class="text-center text-sm mt-6 min-h-[20px]"></p>
    
    <div class="mt-8 text-center text-xs text-slate-400">
      <p><i class="fas fa-shield-alt mr-1"></i> Seus dados estão seguros conosco</p>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 md:py-10 fade-in">

<!-- Header -->
<header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 md:mb-10 gap-4">
  <div class="flex-1">
    <div class="flex items-center gap-3 mb-2">
      <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-md">
        <i class="fas fa-wallet text-white"></i>
      </div>
      <div>
        <h2 class="text-xs uppercase tracking-wide text-slate-500 font-medium">Saldo atual</h2>
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-slate-800">
          R$ <span id="saldo">0,00</span>
        </h1>
      </div>
    </div>
    <p class="text-sm text-slate-500 flex items-center gap-2">
      <span id="saldoStatus" class="inline-flex items-center">
        <i class="fas fa-circle text-xs mr-1"></i>
        <span>Carregando...</span>
      </span>
      <span class="hidden sm:inline">•</span>
      <span class="text-sm"><span id="totalTransacoes">0</span> transações</span>
    </p>
  </div>
  
  <div class="flex items-center gap-3">
    <div class="hidden sm:block text-right">
      <p class="text-sm text-slate-600" id="userEmail">carregando...</p>
      <p class="text-xs text-slate-500">Bem-vindo de volta!</p>
    </div>
    <button id="btnLogout"
      class="px-4 py-2.5 rounded-xl border border-slate-200 hover:border-red-200 hover:bg-red-50 text-slate-600 hover:text-red-600 font-medium transition-all duration-200 flex items-center gap-2">
      <i class="fas fa-sign-out-alt"></i>
      <span class="hidden sm:inline">Sair</span>
    </button>
  </div>
</header>

<!-- Stats Cards -->
<section class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-10">
  <div class="glass p-5 md:p-6 rounded-2xl shadow-soft border-l-4 border-green-500">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-slate-500 text-sm font-medium">Entradas</p>
        <h3 class="text-2xl md:text-3xl font-bold text-green-600 mt-1">
          R$ <span id="receitas">0,00</span>
        </h3>
      </div>
      <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
        <i class="fas fa-arrow-down text-green-600 text-lg"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-3"><span id="qtdReceitas">0</span> receitas registradas</p>
  </div>

  <div class="glass p-5 md:p-6 rounded-2xl shadow-soft border-l-4 border-red-500">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-slate-500 text-sm font-medium">Saídas</p>
        <h3 class="text-2xl md:text-3xl font-bold text-red-500 mt-1">
          R$ <span id="despesas">0,00</span>
        </h3>
      </div>
      <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
        <i class="fas fa-arrow-up text-red-500 text-lg"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-3"><span id="qtdDespesas">0</span> despesas registradas</p>
  </div>

  <div class="glass p-5 md:p-6 rounded-2xl shadow-soft border-l-4 border-blue-500">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-slate-500 text-sm font-medium">Saldo do mês</p>
        <h3 class="text-2xl md:text-3xl font-bold text-blue-600 mt-1">
          R$ <span id="saldoMes">0,00</span>
        </h3>
      </div>
      <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
        <i class="fas fa-chart-line text-blue-600 text-lg"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-3">Período atual</p>
  </div>
</section>

<!-- Main Content -->
<section class="grid lg:grid-cols-3 gap-6 md:gap-8">

<!-- Transactions List -->
<div class="lg:col-span-2">
  <div class="glass p-5 md:p-6 rounded-2xl shadow-soft h-full">
    <div class="flex justify-between items-center mb-6">
      <h3 class="font-semibold text-lg text-slate-800">Movimentações recentes</h3>
      <div class="flex items-center gap-2">
        <button id="btnFiltrarTodas" class="px-3 py-1.5 text-sm bg-emerald-100 text-emerald-700 rounded-lg font-medium">Todas</button>
        <button id="btnFiltrarReceitas" class="px-3 py-1.5 text-sm bg-slate-100 text-slate-600 rounded-lg font-medium hover:bg-slate-200">Entradas</button>
        <button id="btnFiltrarDespesas" class="px-3 py-1.5 text-sm bg-slate-100 text-slate-600 rounded-lg font-medium hover:bg-slate-200">Saídas</button>
      </div>
    </div>
    
    <div id="listaContainer" class="overflow-hidden">
      <!-- Loading state -->
      <div id="loading" class="space-y-3">
        <div class="skeleton h-16 rounded-xl"></div>
        <div class="skeleton h-16 rounded-xl"></div>
        <div class="skeleton h-16 rounded-xl"></div>
      </div>
      
      <!-- Transactions list -->
      <div id="lista" class="space-y-3 max-h-[500px] overflow-y-auto pr-2"></div>
      
      <!-- Empty state -->
      <div id="listaVazia" class="hidden text-center py-10">
        <div class="w-20 h-20 mx-auto bg-slate-100 rounded-full flex items-center justify-center mb-4">
          <i class="fas fa-receipt text-slate-400 text-2xl"></i>
        </div>
        <p class="text-slate-500 font-medium">Nenhuma transação registrada</p>
        <p class="text-slate-400 text-sm mt-1">Adicione sua primeira transação ao lado</p>
      </div>
    </div>
  </div>
</div>

<!-- Add Transaction Form -->
<div class="glass p-5 md:p-6 rounded-2xl shadow-soft h-fit sticky top-6">
  <h3 class="font-semibold text-lg text-slate-800 mb-6 flex items-center gap-2">
    <i class="fas fa-plus-circle text-emerald-500"></i>
    Nova transação
  </h3>

  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-slate-700 mb-1">Valor (R$)</label>
      <div class="relative">
        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-500 font-medium">R$</span>
        <input id="valor" type="number" step="0.01" min="0.01" placeholder="0,00"
          class="w-full pl-12 pr-4 py-3.5 rounded-xl border border-slate-200 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition-all duration-200">
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-slate-700 mb-1">Descrição</label>
      <input id="descricao" placeholder="Almoço, Salário, Uber..."
        class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition-all duration-200">
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Categoria</label>
        <select id="categoria" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition-all duration-200">
          <option value="Alimentação">Alimentação</option>
          <option value="Transporte">Transporte</option>
          <option value="Moradia">Moradia</option>
          <option value="Lazer">Lazer</option>
          <option value="Saúde">Saúde</option>
          <option value="Educação">Educação</option>
          <option value="Salário">Salário</option>
          <option value="Investimentos">Investimentos</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Tipo</label>
        <select id="tipo" class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition-all duration-200">
          <option value="receita">Entrada</option>
          <option value="despesa">Saída</option>
        </select>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-slate-700 mb-1">Data (opcional)</label>
      <input id="data" type="date"
        class="w-full px-4 py-3.5 rounded-xl border border-slate-200 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition-all duration-200">
    </div>

    <button id="btnSalvar"
      class="w-full bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white font-semibold py-3.5 rounded-xl shadow-md hover:shadow-lg transition-all duration-300 mt-2 flex items-center justify-center gap-2">
      <i class="fas fa-save"></i>
      Salvar transação
    </button>
    
    <div class="text-center">
      <button id="btnLimpar" class="text-sm text-slate-500 hover:text-slate-700 mt-2">
        Limpar formulário
      </button>
    </div>
  </div>
</div>

</section>

<!-- Footer -->
<footer class="mt-10 pt-6 border-t border-slate-200 text-center text-sm text-slate-500">
  <p>MinhasEconomias © 2023 • Controle financeiro pessoal</p>
  <p class="text-xs mt-1">v1.0 • <span id="appStatus" class="text-emerald-600 font-medium">Conectado</span></p>
</footer>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

const supabase = createClient(
  "https://jkzsorzwtyeynnwirwrf.supabase.co",
  "sb_publishable_oaPD0x48PzcvVNsMw1xr4A_jb5zSb4G"
);

const $ = id => document.getElementById(id);
let user = null;
let transacoes = [];
let filtroAtual = 'todas';

/* ===== UI HELPERS ===== */
function mostrarMensagem(texto, tipo = 'erro') {
  const msg = $("msg");
  msg.innerText = texto;
  msg.className = `text-center text-sm mt-6 min-h-[20px] ${tipo === 'erro' ? 'text-red-500' : 'text-emerald-600'}`;
  if (tipo === 'sucesso') setTimeout(() => msg.innerText = '', 3000);
}

function atualizarStatusSaldo(saldo) {
  const status = $("saldoStatus");
  if (saldo > 0) {
    status.innerHTML = '<i class="fas fa-circle text-xs mr-1 text-emerald-500"></i><span class="text-emerald-600">Positivo</span>';
  } else if (saldo < 0) {
    status.innerHTML = '<i class="fas fa-circle text-xs mr-1 text-red-500"></i><span class="text-red-600">Negativo</span>';
  } else {
    status.innerHTML = '<i class="fas fa-circle text-xs mr-1 text-slate-500"></i><span class="text-slate-600">Neutro</span>';
  }
}

/* ===== AUTH ===== */
$("btnLogin").onclick = async () => {
  const btn = $("btnLogin");
  const originalText = btn.innerHTML;
  
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
  btn.disabled = true;
  
  const { data, error } = await supabase.auth.signInWithPassword({
    email: $("email").value,
    password: $("senha").value
  });
  
  if (error) {
    mostrarMensagem(error.message);
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
};

$("btnRegistrar").onclick = async () => {
  const btn = $("btnRegistrar");
  const originalText = btn.innerHTML;
  
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando conta...';
  btn.disabled = true;
  
  const { data, error } = await supabase.auth.signUp({
    email: $("email").value,
    password: $("senha").value
  });
  
  if (error) {
    mostrarMensagem(error.message);
  } else {
    mostrarMensagem('Conta criada com sucesso! Verifique seu email.', 'sucesso');
  }
  
  btn.innerHTML = originalText;
  btn.disabled = false;
};

$("togglePassword").onclick = () => {
  const senha = $("senha");
  const icon = $("togglePassword").querySelector("i");
  if (senha.type === "password") {
    senha.type = "text";
    icon.classList.replace("fa-eye", "fa-eye-slash");
  } else {
    senha.type = "password";
    icon.classList.replace("fa-eye-slash", "fa-eye");
  }
};

$("btnLogout").onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

/* ===== FILTERS ===== */
$("btnFiltrarTodas").onclick = () => aplicarFiltro('todas');
$("btnFiltrarReceitas").onclick = () => aplicarFiltro('receita');
$("btnFiltrarDespesas").onclick = () => aplicarFiltro('despesa');

function aplicarFiltro(tipo) {
  filtroAtual = tipo;
  
  // Update filter buttons
  document.querySelectorAll('#btnFiltrarTodas, #btnFiltrarReceitas, #btnFiltrarDespesas').forEach(btn => {
    btn.className = "px-3 py-1.5 text-sm bg-slate-100 text-slate-600 rounded-lg font-medium hover:bg-slate-200";
  });
  
  if (tipo === 'todas') {
    $("btnFiltrarTodas").className = "px-3 py-1.5 text-sm bg-emerald-100 text-emerald-700 rounded-lg font-medium";
  } else if (tipo === 'receita') {
    $("btnFiltrarReceitas").className = "px-3 py-1.5 text-sm bg-emerald-100 text-emerald-700 rounded-lg font-medium";
  } else {
    $("btnFiltrarDespesas").className = "px-3 py-1.5 text-sm bg-emerald-100 text-emerald-700 rounded-lg font-medium";
  }
  
  renderizarTransacoes();
}

/* ===== TRANSACTIONS ===== */
$("btnSalvar").onclick = async () => {
  if (!user) return;
  
  const valor = parseFloat($("valor").value);
  const descricao = $("descricao").value.trim();
  
  if (!valor || valor <= 0) {
    mostrarMensagem('Digite um valor válido maior que zero');
    $("valor").focus();
    return;
  }
  
  if (!descricao) {
    mostrarMensagem('Digite uma descrição');
    $("descricao").focus();
    return;
  }
  
  const btn = $("btnSalvar");
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
  btn.disabled = true;
  
  const transacao = {
    user_id: user.id,
    valor: valor,
    descricao: descricao,
    categoria: $("categoria").value,
    tipo: $("tipo").value,
    data: $("data").value || new Date().toISOString().split('T')[0]
  };
  
  const { error } = await supabase.from("transacoes").insert(transacao);
  
  if (error) {
    mostrarMensagem(error.message);
    btn.innerHTML = originalText;
    btn.disabled = false;
    return;
  }
  
  mostrarMensagem('Transação salva com sucesso!', 'sucesso');
  $("btnLimpar").click();
  carregar();
  
  btn.innerHTML = originalText;
  btn.disabled = false;
};

$("btnLimpar").onclick = () => {
  $("valor").value = "";
  $("descricao").value = "";
  $("categoria").value = "Alimentação";
  $("tipo").value = "receita";
  $("data").value = "";
  $("valor").focus();
};

window.excluir = async (id) => {
  if (!confirm("Tem certeza que deseja excluir esta transação?")) return;
  
  const { error } = await supabase.from("transacoes").delete().eq("id", id);
  
  if (error) {
    mostrarMensagem('Erro ao excluir transação');
    return;
  }
  
  transacoes = transacoes.filter(t => t.id !== id);
  renderizarTransacoes();
  atualizarResumo();
};

function formatarData(dataStr) {
  const data = new Date(dataStr);
  return data.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
}

function formatarMoeda(valor) {
  return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function renderizarTransacoes() {
  const lista = $("lista");
  const listaVazia = $("listaVazia");
  const loading = $("loading");
  
  // Hide loading
  loading.classList.add('hidden');
  
  // Filter transactions
  let transacoesFiltradas = transacoes;
  if (filtroAtual === 'receita') {
    transacoesFiltradas = transacoes.filter(t => t.tipo === 'receita');
  } else if (filtroAtual === 'despesa') {
    transacoesFiltradas = transacoes.filter(t => t.tipo === 'despesa');
  }
  
  if (transacoesFiltradas.length === 0) {
    lista.classList.add('hidden');
    listaVazia.classList.remove('hidden');
    return;
  }
  
  lista.classList.remove('hidden');
  listaVazia.classList.add('hidden');
  
  lista.innerHTML = transacoesFiltradas.map(t => `
    <div class="flex justify-between items-center p-4 rounded-xl hover:bg-slate-50 transition-all duration-200 border border-slate-100 group">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 ${t.tipo === 'receita' ? 'bg-green-100' : 'bg-red-100'} rounded-xl flex items-center justify-center">
          <i class="fas ${t.tipo === 'receita' ? 'fa-arrow-down text-green-600' : 'fa-arrow-up text-red-500'}"></i>
        </div>
        <div>
          <p class="font-medium text-slate-800">${t.descricao}</p>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-xs px-2 py-1 ${t.tipo === 'receita' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} rounded-full">
              ${t.categoria}
            </span>
            <span class="text-xs text-slate-500">${formatarData(t.data)}</span>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <span class="${t.tipo === 'receita' ? 'text-green-600' : 'text-red-500'} font-bold">
          ${t.tipo === 'receita' ? '+' : '-'} R$ ${formatarMoeda(t.valor)}
        </span>
        <button onclick="excluir(${t.id})"
          class="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity duration-200">
          <i class="fas fa-trash-alt"></i>
        </button>
      </div>
    </div>
  `).join('');
}

function atualizarResumo() {
  let receitasTotal = 0;
  let despesasTotal = 0;
  let qtdReceitas = 0;
  let qtdDespesas = 0;
  
  // Current month filter
  const hoje = new Date();
  const mesAtual = hoje.getMonth();
  const anoAtual = hoje.getFullYear();
  
  let receitasMes = 0;
  let despesasMes = 0;
  
  transacoes.forEach(t => {
    const dataTransacao = new Date(t.data);
    
    if (t.tipo === "receita") {
      receitasTotal += t.valor;
      qtdReceitas++;
      
      if (dataTransacao.getMonth() === mesAtual && dataTransacao.getFullYear() === anoAtual) {
        receitasMes += t.valor;
      }
    } else {
      despesasTotal += t.valor;
      qtdDespesas++;
      
      if (dataTransacao.getMonth() === mesAtual && dataTransacao.getFullYear() === anoAtual) {
        despesasMes += t.valor;
      }
    }
  });
  
  const saldoTotal = receitasTotal - despesasTotal;
  const saldoMes = receitasMes - despesasMes;
  
  // Update UI
  $("receitas").innerText = formatarMoeda(receitasTotal);
  $("despesas").innerText = formatarMoeda(despesasTotal);
  $("saldo").innerText = formatarMoeda(saldoTotal);
  $("saldoMes").innerText = formatarMoeda(saldoMes);
  $("qtdReceitas").innerText = qtdReceitas;
  $("qtdDespesas").innerText = qtdDespesas;
  $("totalTransacoes").innerText = transacoes.length;
  
  atualizarStatusSaldo(saldoTotal);
}

/* ===== DATA LOADING ===== */
async function carregar() {
  if (!user) return;
  
  $("userEmail").innerText = user.email;
  
  const { data, error } = await supabase
    .from("transacoes")
    .select("*")
    .eq("user_id", user.id)
    .order("data", { ascending: false })
    .order("created_at", { ascending: false });
  
  if (error) {
    console.error("Erro ao carregar transações:", error);
    return;
  }
  
  transacoes = data || [];
  renderizarTransacoes();
  atualizarResumo();
}

/* ===== SESSION ===== */
supabase.auth.onAuthStateChange((_, session) => {
  if (session) {
    user = session.user;
    $("loginTela").classList.add("hidden");
    $("app").classList.remove("hidden");
    carregar();
  } else {
    user = null;
    $("loginTela").classList.remove("hidden");
    $("app").classList.add("hidden");
  }
});

// Set today's date as default
window.onload = () => {
  const hoje = new Date().toISOString().split('T')[0];
  $("data").value = hoje;
  $("data").max = hoje;
};
</script>
</body>
</html>