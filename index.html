<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minhas Economias</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<style>
body{
  font-family:'Plus Jakarta Sans',sans-serif;
  background:#f8fafc;
}
.modal{
  transform:translateY(100%);
  transition:.3s;
}
.modal-open{
  transform:translateY(0);
}
.camera-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  background:#eef2ff;
  padding:14px;
  border-radius:16px;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
.camera-btn:hover{
  background:#e0e7ff;
}
.preview{
  width:100%;
  border-radius:16px;
  margin-top:10px;
  display:none;
}
.loader{
  display:none;
  margin-top:10px;
  text-align:center;
  font-size:14px;
  color:#64748b;
}
</style>
</head>

<body class="h-screen overflow-hidden">

<!-- LOGIN -->
<div id="loginTela" class="fixed inset-0 flex items-center justify-center bg-slate-100">
  <div class="bg-white p-8 rounded-3xl shadow-xl w-80">
    <h1 class="text-2xl font-extrabold mb-6 text-center">Minhas Economias</h1>
    <input id="usuario" value="admin" class="w-full p-3 mb-3 bg-slate-100 rounded-xl">
    <input id="senha" value="1234" type="password" class="w-full p-3 mb-6 bg-slate-100 rounded-xl">
    <button onclick="login()" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold">Entrar</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden h-full flex">

<!-- SIDEBAR -->
<aside class="w-64 bg-white border-r p-6 hidden md:block">
  <h2 class="font-extrabold text-xl mb-6">MinhasEcon.</h2>
  <button onclick="mostrar('dash')" class="w-full p-3 mb-2 rounded-xl bg-indigo-50 font-bold">Dashboard</button>
  <button onclick="mostrar('extrato')" class="w-full p-3 rounded-xl">Extrato</button>
</aside>

<!-- MAIN -->
<main class="flex-1 p-6 overflow-y-auto">

<header class="flex justify-between items-center mb-6">
  <h2 class="text-xl font-bold">Controle Financeiro</h2>
  <input type="month" id="mes" class="bg-slate-100 p-2 rounded-xl">
</header>

<!-- DASH -->
<div id="dash">

<div class="bg-indigo-600 text-white p-6 rounded-3xl mb-6 shadow">
  <p class="opacity-80">Saldo do m√™s</p>
  <h1 class="text-4xl font-extrabold">R$ <span id="saldo">0,00</span></h1>
</div>

<div class="bg-white p-6 rounded-2xl mb-6 shadow">
  <h3 class="font-bold mb-4">Lan√ßamentos</h3>
  <div id="lista" class="space-y-2"></div>
</div>

<div class="flex gap-3">
  <button onclick="abrirModal('receita')" class="flex-1 bg-emerald-500 text-white py-3 rounded-xl font-bold">+ Receita</button>
  <button onclick="abrirModal('despesa')" class="flex-1 bg-rose-500 text-white py-3 rounded-xl font-bold">- Despesa</button>
</div>

</div>

<!-- EXTRATO -->
<div id="extrato" class="hidden">
  <button onclick="mostrar('dash')" class="mb-4 font-bold">‚Üê Voltar</button>

  <div class="bg-white p-6 rounded-2xl shadow">
    <div class="flex justify-between mb-4">
      <h2 class="font-bold text-xl">Extrato</h2>
      <button onclick="exportarExcel()" class="bg-emerald-500 text-white px-4 py-2 rounded-xl font-bold">Excel</button>
    </div>
    <div id="listaExtrato" class="space-y-2"></div>
  </div>
</div>

</main>
</div>

<!-- MODAL -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-end">
  <div class="bg-white p-6 w-full rounded-t-3xl modal">
    <h3 id="titulo" class="font-bold text-xl mb-4"></h3>

    <input id="valor" type="number" placeholder="Valor" class="w-full p-3 bg-slate-100 rounded-xl mb-3">
    <input id="desc" placeholder="Descri√ß√£o" class="w-full p-3 bg-slate-100 rounded-xl mb-3">

    <select id="categoria" class="w-full p-3 bg-slate-100 rounded-xl mb-3">
      <option>Alimenta√ß√£o</option>
      <option>Transporte</option>
      <option>Moradia</option>
      <option>Sa√∫de</option>
      <option>Educa√ß√£o</option>
      <option>Outros</option>
    </select>

    <!-- CAMERA -->
    <label class="camera-btn mb-3">
      <span class="material-icons-round text-indigo-600">photo_camera</span>
      Enviar foto da nota
      <input type="file" accept="image/*" capture="environment" hidden onchange="lerNota(this)">
    </label>

    <img id="preview" class="preview">
    <div id="loader" class="loader">üì∑ Lendo nota fiscal...</div>

    <button onclick="salvar()" class="w-full bg-indigo-600 text-white p-3 rounded-xl font-bold mt-4">Salvar</button>
  </div>
</div>

<script>
let transacoes=[], tipoAtual='', mesAtual='';

function login(){
  loginTela.classList.add('hidden');
  app.classList.remove('hidden');
  init();
}

function init(){
  transacoes = JSON.parse(localStorage.getItem('dados')||'[]');
  const d=new Date();
  mes.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  mesAtual = mes.value;
  mes.onchange = e => { mesAtual=e.target.value; render(); };
  render();
}

function mostrar(t){
  dash.classList.toggle('hidden', t!=='dash');
  extrato.classList.toggle('hidden', t!=='extrato');
}

function abrirModal(tipo){
  tipoAtual = tipo;
  titulo.innerText = tipo==='receita'?'Nova Receita':'Nova Despesa';
  modal.classList.remove('hidden');
  setTimeout(()=>modal.firstElementChild.classList.add('modal-open'),10);
}

function salvar(){
  if(!valor.value || !desc.value) return alert('Preencha os campos');

  const [ano,mes] = mesAtual.split('-');

  transacoes.push({
    id:Date.now(),
    tipo:tipoAtual,
    valor:+valor.value,
    desc:desc.value,
    categoria:categoria.value,
    data:`${ano}-${mes}-01`
  });

  localStorage.setItem('dados',JSON.stringify(transacoes));
  modal.classList.add('hidden');
  preview.style.display='none';
  render();
}

function filtrar(){
  return transacoes.filter(t=>t.data.startsWith(mesAtual));
}

function render(){
  const dados = filtrar();
  const saldoMes = dados.reduce((s,t)=>s+(t.tipo==='receita'?t.valor:-t.valor),0);
  saldo.innerText = saldoMes.toFixed(2).replace('.',',');

  const html = dados.map(t=>`
    <div class="flex justify-between bg-slate-50 p-3 rounded-xl">
      <div>
        <p class="font-semibold">${t.desc}</p>
        <p class="text-xs text-slate-500">${t.categoria}</p>
      </div>
      <span class="${t.tipo==='receita'?'text-emerald-600':'text-rose-600'} font-bold">
        R$ ${t.valor.toFixed(2)}
      </span>
    </div>
  `).join('');

  lista.innerHTML = html;
  listaExtrato.innerHTML = html;
}

function lerNota(input){
  const img = input.files[0];
  if(!img) return;

  loader.style.display = 'block';

  Tesseract.recognize(img, 'por').then(r => {
    loader.style.display = 'none';

    const linhas = r.data.text
      .split('\n')
      .map(l => l.trim())
      .filter(l => l.length);

    let valorTotal = null;

    function extrairValor(texto){
      const m = texto.match(/(\d+[.,]\d{2})/);
      if(!m) return null;
      return parseFloat(m[1].replace(',','.'));
    }

    function linhaBloqueada(l){
      return (
        l.includes('CNPJ') ||
        l.includes('CPF') ||
        l.includes('IE') ||
        l.includes('MD5') ||
        l.includes('COO') ||
        l.includes('ITEM') ||
        l.includes('COD') ||
        l.includes('/') ||
        /\d{6,}/.test(l)
      );
    }

    // üî• REGRA DE OURO ‚Äî TOTAL
    for(let i = 0; i < linhas.length; i++){
      const l = linhas[i].toUpperCase();

      if(l.includes('TOTAL')){
        let v = extrairValor(l);
        if(v){
          valorTotal = v;
          break;
        }

        if(i + 1 < linhas.length){
          const abaixo = linhas[i + 1].toUpperCase();
          if(!linhaBloqueada(abaixo)){
            v = extrairValor(abaixo);
            if(v){
              valorTotal = v;
              break;
            }
          }
        }
      }
    }

    if(!valorTotal){
      alert('N√£o foi poss√≠vel identificar o TOTAL da nota.');
      return;
    }

    document.getElementById('valor').value =
      valorTotal.toFixed(2);

    // Descri√ß√£o autom√°tica opcional
    const desc = linhas.find(l =>
      !linhaBloqueada(l) &&
      l.length > 10 &&
      !l.match(/TOTAL/i)
    );

    if(desc){
      document.getElementById('desc').value =
        desc.substring(0,60);
    }

    // üîí LIMPA A FOTO DA MEM√ìRIA
    input.value = '';
  });
}



function exportarExcel(){
  const dados = filtrar().map(t=>({
    Data:t.data,
    Tipo:t.tipo,
    Descricao:t.desc,
    Categoria:t.categoria,
    Valor:t.valor
  }));

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Extrato');
  XLSX.writeFile(wb,'extrato.xlsx');
}
</script>

</body>
</html>
